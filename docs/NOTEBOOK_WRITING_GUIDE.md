# 高质量 Jupyter Notebook 教程编写指南

> 本指南总结了一套经过验证的教程编写标准，用于指导 AI 或人工编写可执行、可落地、贴近生产环境的深度学习教程。

## 核心理念

```
寓教于乐 > 枯燥讲解
真实场景 > 抽象概念
动手实践 > 被动阅读
循序渐进 > 一步到位
```

## 一、内容结构模板

每个 Notebook 应包含以下结构：

```
1. 标题与学习目标
2. 背景故事/真实场景引入
3. 核心概念讲解（配公式）
4. 环境准备与数据生成
5. 分步实现（含 TODO 代码块）
6. 可视化与结果分析
7. 思考题
8. 总结表格
9. 延伸阅读（可选）
```

### 1.1 标题格式

```markdown
# 🎯 Chapter X Exercise Y: 主题名称

## 学习目标
完成本练习后，你将能够：
1. 理解 XXX 的核心原理
2. 实现 XXX 算法
3. 在真实场景中应用 XXX
```

### 1.2 背景故事要求

**❌ 错误示范（枯燥抽象）：**
```markdown
CATE（条件平均处理效应）是因果推断中的重要概念，
定义为 τ(x) = E[Y(1) - Y(0) | X = x]
```

**✅ 正确示范（生动具体）：**
```markdown
## 🎬 真实场景：网约车司机激励策略

想象你是滴滴的运营负责人，手握 1000 万激励预算。
公司有 100 万注册司机，但不是每个司机对激励的反应都一样：

- 👨‍💼 **全职司机老王**：已经每天跑 12 小时，给不给补贴都一样拼
- 👩‍🎓 **兼职司机小李**：平时上班，周末看心情，补贴高了才愿意多跑
- 🧓 **佛系司机老张**：接单纯属消遣，补贴对他没用

问题来了：**同样的钱，应该发给谁？**
```

## 二、公式呈现规范

### 2.1 核心公式必须包含

- 公式本身（LaTeX 格式）
- 符号说明
- 直观解释

```markdown
### 📐 核心公式

$$\tau(x) = E[Y(1) - Y(0) | X = x]$$

**符号说明：**
| 符号 | 含义 |
|------|------|
| $\tau(x)$ | 特征为 $x$ 的个体的处理效应 |
| $Y(1)$ | 接受处理的潜在结果 |
| $Y(0)$ | 未接受处理的潜在结果 |

**直观理解：** 就像问"如果这个特定的人吃了药，比不吃药会好多少？"
```

### 2.2 复杂公式分步推导

```markdown
**Step 1: 定义目标**
$$\hat{\tau}(x) = \hat{\mu}_1(x) - \hat{\mu}_0(x)$$

**Step 2: 分别建模**
- 处理组：$\hat{\mu}_1(x) = f_1(x)$，用 $(X_i, Y_i)$ where $T_i=1$ 训练
- 对照组：$\hat{\mu}_0(x) = f_0(x)$，用 $(X_i, Y_i)$ where $T_i=0$ 训练

**Step 3: 预测效应**
对新样本 $x_{new}$：$\hat{\tau}(x_{new}) = f_1(x_{new}) - f_0(x_{new})$
```

## 三、代码编写规范

### 3.1 TODO 代码块格式

```python
# TODO 1: 实现 T-Learner 的处理组模型
# 提示：
# - 筛选处理组数据 (T == 1)
# - 使用 GradientBoostingRegressor
# - 特征：X_train[mask], 目标：y_train[mask]

def train_treatment_model(X_train, y_train, T_train):
    """
    训练处理组模型

    参数:
        X_train: 特征矩阵
        y_train: 结果变量
        T_train: 处理变量

    返回:
        训练好的模型
    """
    # === 你的代码 ===


    # === 代码结束 ===
    return model
```

### 3.2 参考答案格式

```python
# 📝 参考答案（先自己尝试！）
# ================================
# mask = T_train == 1
# model = GradientBoostingRegressor(n_estimators=100, max_depth=4)
# model.fit(X_train[mask], y_train[mask])
# return model
```

### 3.3 代码注释要求

```python
# 好的注释：解释"为什么"
# honest=True: 使用诚实分裂，用不同的样本进行分裂和估计，减少过拟合

# 差的注释：解释"是什么"（代码本身已经说明）
# 设置 honest 为 True
```

## 四、可视化规范

### 4.1 统一风格

```python
import plotly.graph_objects as go
import plotly.express as px

# 颜色方案
COLORS = {
    'primary': '#2D9CDB',    # 主蓝色
    'success': '#27AE60',    # 绿色（正向效应）
    'danger': '#EB5757',     # 红色（负向效应）
    'warning': '#F2994A',    # 橙色（警告）
    'neutral': '#828282',    # 灰色（中性）
}

# 模板
fig.update_layout(template='plotly_white')
```

### 4.2 图表必须包含

- 清晰的标题
- 坐标轴标签
- 图例（如有多系列）
- 适当的注释

```python
fig.update_layout(
    title='CATE 分布：谁是最佳干预对象？',
    xaxis_title='条件平均处理效应 (CATE)',
    yaxis_title='用户数量',
    showlegend=True
)
```

## 五、思考题设计

### 5.1 层次递进

```markdown
## 💡 思考题

### 基础理解
1. 为什么 T-Learner 需要分别训练两个模型？如果只用一个模型会怎样？

### 深入分析
2. 当处理组和对照组样本量严重不平衡时，T-Learner 会有什么问题？

### 实战应用
3. 如果你是电商运营，发现某用户群体的 CATE 为负，你会怎么处理？
```

### 5.2 与真实场景关联

```markdown
### 业务决策
4. 假设发券成本是 10 元/张，用户 CATE 为 15 元，ROI 是多少？
   如果 CATE 为 8 元呢？这时候应该发券吗？
```

## 六、总结表格模板

```markdown
## 📋 本章小结

| 概念 | 定义 | 应用场景 | 优缺点 |
|------|------|----------|--------|
| T-Learner | 分别建模处理组和对照组 | 样本充足时 | ✅简单直观 ❌样本不平衡时效果差 |
| X-Learner | 利用交叉预测修正 | 样本不平衡时 | ✅处理不平衡 ❌计算复杂 |
| Causal Forest | 基于树的非参数方法 | 高维特征时 | ✅自动发现异质性 ❌解释性较弱 |
```

## 七、数据生成规范

### 7.1 真实场景映射

```python
def generate_driver_data(n_samples=5000, seed=42):
    """
    生成网约车司机数据

    场景：滴滴司机激励实验
    - 特征：工作类型、历史接单量、活跃天数、评分
    - 处理：是否发放激励补贴
    - 结果：下周接单量
    """
    np.random.seed(seed)

    # 司机特征（有业务含义）
    is_fulltime = np.random.binomial(1, 0.3, n_samples)  # 30%全职
    historical_orders = np.random.poisson(50, n_samples)  # 历史周均接单
    active_days = np.random.randint(1, 8, n_samples)      # 周活跃天数
    rating = np.clip(np.random.normal(4.5, 0.3, n_samples), 3, 5)  # 评分

    # 真实的异质效应（核心！）
    true_cate = (
        5 * (1 - is_fulltime) +           # 兼职司机效应更大
        0.1 * (7 - active_days) +         # 不太活跃的司机效应更大
        np.random.normal(0, 1, n_samples) # 随机噪声
    )

    return X, T, Y, true_cate
```

### 7.2 效应设计原则

1. **效应要有业务含义**：不是随机生成，而是反映真实业务逻辑
2. **包含异质性**：不同群体效应不同
3. **保留真实值**：用于评估模型效果

## 八、质量检查清单

### 发布前必须检查：

- [ ] **可执行性**：所有代码单元格能顺序执行，无报错
- [ ] **自洽性**：前后变量名、数据一致
- [ ] **教学性**：TODO 有足够提示，参考答案可选查看
- [ ] **趣味性**：有真实场景，有生动比喻
- [ ] **完整性**：包含思考题和总结
- [ ] **可视化**：关键结果有图表展示
- [ ] **深度**：不仅 How，还有 Why

### 常见问题避免：

| 问题 | 解决方案 |
|------|----------|
| 代码跑不通 | 完整测试所有单元格 |
| 概念跳跃 | 增加过渡段落 |
| 太抽象 | 增加真实场景和比喻 |
| 太简单 | 增加思考题和进阶内容 |
| 图表丑陋 | 统一使用 plotly_white 模板 |

## 九、AI 生成提示词模板

当需要 AI 生成新教程时，使用以下提示词：

```
请根据以下要求生成一个 Jupyter Notebook 教程：

【主题】：{主题名称}
【目标读者】：有一定 Python 基础，想学习因果推断的数据分析师/算法工程师
【难度】：{入门/进阶/高级}

【要求】：
1. 寓教于乐：用真实业务场景引入，避免枯燥的学术定义
2. 生动比喻：用生活化的例子解释复杂概念
3. 动手实践：包含 3-5 个 TODO 代码块，提供提示和参考答案
4. 公式完整：核心公式用 LaTeX，配符号说明和直观解释
5. 可视化丰富：用 Plotly 绑制交互式图表
6. 深度适中：不仅 How，还要 Why
7. 结构完整：学习目标 → 场景引入 → 概念讲解 → 代码实现 → 思考题 → 总结

【参考结构】：
- 标题（含 emoji）
- 学习目标（3-4 点）
- 真实场景故事
- 核心概念（含公式）
- 环境准备
- 数据生成（有业务含义）
- 分步实现（TODO 块）
- 可视化分析
- 思考题（基础→进阶→应用）
- 总结表格
```

## 十、示例参考

本项目的以下 Notebook 是高质量范例：

| Notebook | 亮点 |
|----------|------|
| `chapter4_ex3_dragonnet.ipynb` | "三头龙"比喻，架构图解 |
| `chapter5_ex3_sensitivity_analysis.ipynb` | FDA 审查员场景，三剑客体系 |
| `chapter6_ex1_coupon_optimization.ipynb` | 四象限用户分类，ROI 计算 |
| `chapter6_ex3_user_targeting.ipynb` | 网约车场景，策略对比 |

---

> 📝 **最后提醒**：好的教程不是知识的堆砌，而是一场引人入胜的学习旅程。
> 每写一段，问问自己：**"如果我是读者，这里会不会走神？"**
