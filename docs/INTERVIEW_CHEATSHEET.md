# 因果推断 & 营销算法面试速查表

> 面向 Google/Meta/Grab/字节/阿里等大厂的数据科学 & 营销算法岗位
> 覆盖高频考点，帮助快速准备面试

---

## 一、基础概念类（必考）

### Q1: 什么是潜在结果框架（Rubin Causal Model）？

**标准答案**：
- 每个个体有两个**潜在结果** Y(1) 和 Y(0)
- Y(1)：接受处理的结果
- Y(0)：不接受处理的结果
- **因果效应**：τ = Y(1) - Y(0)
- **根本问题**：每个个体只能观察到一个潜在结果（反事实不可观测）

**加分点**：提到 SUTVA 假设（稳定单位处理值假设）

---

### Q2: ATE / ATT / ATC / CATE 的区别？

| 指标 | 全称 | 定义 | 适用场景 |
|------|------|------|----------|
| **ATE** | Average Treatment Effect | E[Y(1) - Y(0)] | 评估政策对全体的效果 |
| **ATT** | Average Treatment Effect on Treated | E[Y(1) - Y(0) \| T=1] | 评估已接受处理者的效果 |
| **ATC** | Average Treatment Effect on Control | E[Y(1) - Y(0) \| T=0] | 预测未处理者如果处理的效果 |
| **CATE** | Conditional Average Treatment Effect | E[Y(1) - Y(0) \| X=x] | 个性化处理效应 |

**加分点**：
- ATT ≠ ATE 当存在**选择性处理**时
- CATE 是 Uplift 建模的核心

---

### Q3: DAG 的三种基本结构？

```
1. 链 (Chain): X → Z → Y
   - Z 是中介变量
   - 控制 Z 会阻断 X 对 Y 的影响

2. 叉 (Fork): X ← Z → Y
   - Z 是混淆变量
   - 必须控制 Z 才能识别 X 对 Y 的因果效应

3. 对撞 (Collider): X → Z ← Y
   - Z 是对撞变量
   - 不能控制 Z，否则会引入虚假关联
```

**面试陷阱**：问你"应该控制哪些变量"时，记住**不要控制对撞变量**！

---

### Q4: 什么是 d-分离？

**定义**：判断 DAG 中两个变量是否条件独立的准则

**规则**：
1. **链**：X → Z → Y，控制 Z 后 X ⊥ Y
2. **叉**：X ← Z → Y，控制 Z 后 X ⊥ Y
3. **对撞**：X → Z ← Y，不控制 Z 时 X ⊥ Y，控制 Z 后 X 不独立于 Y

**应用**：判断需要控制哪些混淆变量

---

### Q5: 后门准则 vs 前门准则？

**后门准则**（Back-door Criterion）：
- 条件：控制变量集 Z 阻断所有从 T 到 Y 的后门路径
- 公式：P(Y|do(T)) = Σ P(Y|T,Z) P(Z)
- 常用方法：PSM、IPW、DR

**前门准则**（Front-door Criterion）：
- 条件：存在中介变量 M，T → M → Y，且无 T→Y 的直接后门
- 公式：P(Y|do(T)) = Σ P(M|T) Σ P(Y|M,T') P(T')
- 适用场景：有未观测混淆但有完全中介的情况

---

## 二、方法选择类（高频）

### Q1: 什么情况下用什么方法？（决策树）

```
我想估计 T 对 Y 的因果效应
    │
    ├── 能做随机实验吗？
    │       ├── 能 → A/B Testing
    │       └── 不能 → 继续判断
    │
    ├── 有「自然实验」吗？
    │       ├── 有时间断点 → DID
    │       ├── 有政策门槛 → RDD
    │       ├── 有工具变量 → IV
    │       └── 没有 → 继续判断
    │
    ├── 能控制所有混淆变量吗？
    │       ├── 能 → PSM / IPW / DR
    │       └── 不能 → 敏感性分析 + 谨慎解释
    │
    └── 目标是 ATE 还是 CATE？
            ├── ATE → 传统方法
            └── CATE → Meta-Learners / 因果森林
```

---

### Q2: PSM vs IPW vs DR 如何选择？

| 方法 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| **PSM** | 直观、可解释 | 丢弃不匹配样本 | 样本充足、需可解释性 |
| **IPW** | 使用全部样本 | 权重可能极端 | 权重不极端的情况 |
| **DR** | 双重稳健 | 计算复杂 | 默认推荐、高维协变量 |

**关键点**：
- DR (Doubly Robust) 只需倾向得分或结果模型之一正确即可一致
- 实际中推荐默认使用 DR/AIPW

---

### Q3: DID 的核心假设是什么？如何检验？

**核心假设**：平行趋势假设（Parallel Trends）
- 如果没有处理，处理组和对照组的变化趋势相同

**检验方法**：
1. **图形化检验**：处理前两组趋势是否平行
2. **统计检验**：处理前各期交互项是否显著
3. **安慰剂检验**：假设处理发生在其他时间
4. **Event Study**：估计各期动态效应

**平行趋势不满足怎么办**：
- 合成控制法
- 条件平行趋势（控制协变量）
- 三重差分 (DDD)

---

### Q4: RDD vs DID 的区别？

| 维度 | DID | RDD |
|------|-----|-----|
| **识别条件** | 平行趋势 | 断点处连续性 |
| **数据要求** | 面板数据 | 截面数据即可 |
| **估计效应** | ATT | LATE（断点处局部效应）|
| **适用场景** | 政策时间断点 | 政策门槛断点 |

---

### Q5: IV 的三个假设分别是什么？

1. **相关性** (Relevance)：Z 与 T 相关
   - 检验：第一阶段 F 统计量 > 10

2. **排他性** (Exclusion)：Z 只通过 T 影响 Y
   - 不可直接检验，需理论支持

3. **外生性** (Exogeneity)：Z 与误差项不相关
   - 多 IV 时可用过度识别检验 (Hansen J)

**LATE 解释**：IV 估计的是 Compliers 的局部效应，不是 ATE

---

## 三、实验设计类（必考）

### Q1: CUPED 的原理是什么？

**核心思想**：利用实验前协变量减少方差

**公式**：
```
Y_adj = Y - θ(X - E[X])
θ = Cov(Y, X) / Var(X)
```

**方差缩减**：
```
Var(Y_adj) = Var(Y)(1 - ρ²)
```
其中 ρ 是 X 和 Y 的相关系数

**实践建议**：
- 使用实验前同一指标作为协变量效果最好
- 可以用多个协变量（多元回归）

---

### Q2: 如何处理 A/B 测试中的网络效应？

**问题**：用户之间存在相互影响，违反 SUTVA

**解决方案**：

1. **聚类随机化**
   - 以群组为单位随机化（如城市、学校）
   - 缺点：有效样本量下降

2. **Ego-cluster 方法**
   - 基于社交网络划分 Ego 网络
   - 每个 Ego 网络整体分配处理

3. **溢出效应建模**
   - 显式估计直接效应和间接效应
   - 模型：Y = β₀ + β₁T + β₂T_neighbors + ...

---

### Q3: MAB vs A/B Testing 如何选择？

| 维度 | A/B Testing | MAB |
|------|-------------|-----|
| **目标** | 严格估计效应 | 最大化收益 |
| **样本分配** | 固定比例 | 动态调整 |
| **何时用** | 需要因果推断 | 探索阶段优化 |
| **Regret** | 高（50% 给劣策略）| 低 |

**MAB 常用算法**：
- **Thompson Sampling**：贝叶斯方法，采样决策
- **UCB**：置信上界，乐观主义
- **LinUCB**：带上下文的 UCB

---

### Q4: 如何估计长期效应？

**问题**：实验周期短，但关心长期指标

**Surrogate Index 方法**：
1. 找短期代理变量 S
2. 建立 S 与长期结果 Y 的关系
3. 用实验估计处理对 S 的效应
4. 预测长期效应

**关键假设**：Surrogate Criterion
- S 包含 T 对 Y 的所有信息
- P(Y|T, S) = P(Y|S)

---

### Q5: 什么是 SRM？如何检测？

**SRM** (Sample Ratio Mismatch)：实际分流比例偏离预期

**检测方法**：
```python
from scipy.stats import chisquare
observed = [n_treatment, n_control]
expected_ratio = [0.5, 0.5]
expected = [sum(observed) * r for r in expected_ratio]
chi2, p_value = chisquare(observed, expected)
```

**常见原因**：
- 分流逻辑 bug
- 数据 pipeline 问题
- 用户行为差异（如某组加载慢导致流失）

**SRM 出现后**：必须排查原因，实验结果不可信！

---

## 四、CATE / Uplift 类（营销算法核心）

### Q1: S/T/X/R-Learner 的区别？

| Learner | 方法 | 优点 | 缺点 |
|---------|------|------|------|
| **S-Learner** | 单模型，T 作为特征 | 简单 | 可能欠拟合异质性 |
| **T-Learner** | 两个模型分别建模 | 灵活 | 可能过拟合，样本不平衡问题 |
| **X-Learner** | 两阶段交叉 | 适合处理组样本少 | 较复杂 |
| **R-Learner** | 直接优化 CATE 损失 | 与 DML 相关，效果好 | 需要 Cross-fitting |
| **DR-Learner** | 结合双重稳健 | 最稳健 | 计算复杂 |

**选择建议**：
- 数据量小、处理不平衡 → X-Learner
- 高维协变量 → R-Learner 或 DR-Learner
- 快速原型 → T-Learner

---

### Q2: 因果森林的 Honest Splitting 是什么？

**问题**：普通随机森林无法输出有效的置信区间

**Honest Splitting**：
1. **分裂样本**：一半数据用于决定分裂点
2. **估计样本**：另一半数据用于叶节点估计
3. 两份数据完全独立

**优点**：
- 可以构造有效的置信区间
- 估计更稳健

---

### Q3: Qini 曲线如何解读？

```
Y轴: 累计增量转化 = Σ(τ_i × r_i) - (处理组转化率 - 对照组转化率) × rank/N
X轴: 按 Uplift 预测值排序的人群比例 (0-100%)

理想曲线: 先升后降（Persuadables 在前）
随机基线: 直线
AUUC: 曲线与基线之间的面积
```

**解读**：
- 曲线越高 → 排序能力越强
- 曲线先升后降 → 正确识别了 Persuadables
- 曲线下降 → 识别了 Sleeping Dogs

---

### Q4: Uplift 建模 vs 响应率建模的本质区别？

| 维度 | 响应率建模 | Uplift 建模 |
|------|-----------|-------------|
| **目标** | P(Y=1\|X) | P(Y=1\|T=1,X) - P(Y=1\|T=0,X) |
| **含义** | 谁会转化 | 谁因为处理而转化 |
| **问题** | 会选中"本来就会买"的人 | 识别真正被营销影响的人 |
| **业务价值** | 可能浪费预算 | 最大化增量效果 |

**四类用户**：
1. **Persuadables**：处理后转化，不处理不转化 ← 目标用户
2. **Sure Things**：无论如何都转化
3. **Lost Causes**：无论如何都不转化
4. **Sleeping Dogs**：处理后反而不转化 ← 避免触达

---

## 五、营销应用类

### Q1: Shapley 归因的原理？

**来自合作博弈论**：每个渠道的贡献 = 它对所有可能联盟的边际贡献的平均

**公式**：
```
φᵢ = Σ [|S|!(n-|S|-1)!/n!] × [v(S∪{i}) - v(S)]
```

**性质**（公理）：
1. **效率性**：所有归因之和等于总价值
2. **对称性**：相同贡献的渠道归因相同
3. **虚拟者**：无贡献的渠道归因为 0
4. **可加性**：不同游戏的归因可以相加

**计算复杂度**：O(2^n)，实践中用采样近似

---

### Q2: 增量归因 vs 触达归因的区别？

| 维度 | 触达归因 | 增量归因 |
|------|---------|---------|
| **问题** | 谁"参与了"转化 | 谁"导致了"转化 |
| **方法** | Last-touch, Shapley 等 | 因果推断方法 |
| **数据需求** | 触点日志 | 需要对照组 |
| **业务决策** | 可能误导预算分配 | 正确的预算分配 |

**增量归因方法**：
- 随机实验（金标准）
- PSW (Propensity Score Weighting)
- 增量因果森林

---

### Q3: 如何做预算分配优化？

**核心思想**：边际 ROI 均等化

**方法**：
1. **响应曲线建模**：每个渠道的投入-产出关系
2. **边际 ROI 计算**：dY/dX 在当前预算点的值
3. **优化**：将预算从边际 ROI 低的渠道转移到高的渠道
4. **约束**：总预算、渠道最小/最大投入

**公式**：
```
max Σ f_i(x_i)
s.t. Σ x_i ≤ B (预算约束)
     x_i ≥ 0
```

---

## 六、高级问题类（加分项）

### Q1: 敏感性分析的 E-value 是什么？

**定义**：使观察到的关联完全消失所需的未观测混淆的最小强度

**计算**：
```
E-value = RR + √(RR × (RR - 1))
```
其中 RR 是观察到的风险比

**解读**：
- E-value = 2 → 需要 2 倍强度的混淆才能解释掉效应
- E-value 越大 → 结果越稳健

---

### Q2: DML (Double Machine Learning) 的核心思想？

**问题**：高维协变量下，传统方法的正则化会引入偏差

**解决**：
1. **正交化**：构造对 nuisance 参数不敏感的矩估计
2. **Cross-fitting**：避免过拟合带来的偏差

**两阶段**：
1. 用一部分数据估计 nuisance 参数（倾向得分、结果模型）
2. 用另一部分数据估计因果参数

**关键公式**（Partially Linear Model）：
```
Y = τT + g(X) + ε
T = m(X) + η

τ = E[(Y - g(X))(T - m(X))] / E[(T - m(X))²]
```

---

### Q3: 如何处理连续处理变量？

**方法**：Generalized Propensity Score (GPS)

**步骤**：
1. 估计 GPS：P(T|X) 用连续分布（如正态）
2. 估计剂量-响应函数：E[Y|T=t]
3. 利用 GPS 调整混淆

**输出**：剂量-响应曲线，而非单一效应值

---

### Q4: 中介分析与因果推断的关系？

**问题**：理解效应的机制

**分解**：
```
总效应 = 直接效应 + 间接效应
ATE = NDE + NIE
```

- **NDE** (Natural Direct Effect)：不通过中介的效应
- **NIE** (Natural Indirect Effect)：通过中介的效应

**识别条件**：
1. 无处理-结果混淆
2. 无处理-中介混淆
3. 无中介-结果混淆
4. 无处理导致的中介-结果混淆

---

## 七、场景题（Case Study）

### Case 1: 你如何设计一个发券实验？

**标准答案框架**：

1. **目标确定**
   - 业务目标：提升 GMV / 转化率
   - 统计目标：估计发券的增量效应

2. **实验设计**
   - 随机单位：用户级
   - 分组：发券 vs 不发券
   - 样本量：基于 MDE 计算

3. **指标设计**
   - 主要指标：增量 GMV
   - 护栏指标：券核销率、毛利
   - 诊断指标：发券成本、客单价

4. **风险控制**
   - AA 测试验证系统
   - 监控 SRM
   - 设置紧急停止规则

5. **分析方法**
   - CUPED 减少方差
   - 异质性分析（CATE）
   - 敏感性分析

---

### Case 2: 如果观察到 A/B 测试效果显著但上线后没效果？

**排查思路**：

1. **新奇效应 / 学习效应**
   - 短期行为变化不持久
   - 解决：延长实验周期

2. **网络效应**
   - 实验期间溢出效应
   - 解决：聚类随机化

3. **样本不一致**
   - 实验人群 vs 上线人群不同
   - 解决：检查人群覆盖

4. **时间效应**
   - 实验期间有特殊事件
   - 解决：检查时间趋势

5. **实现差异**
   - 实验版本 vs 上线版本不同
   - 解决：Code review

---

### Case 3: 没有 A/B 测试数据，如何估计营销效果？

**答案**：使用观测数据因果推断方法

1. **方法选择**
   - 有时间断点 → DID
   - 有政策门槛 → RDD
   - 有工具变量 → IV
   - 仅有混淆变量 → PSM/IPW/DR

2. **关键步骤**
   - 画 DAG 分析混淆结构
   - 检查共同支撑
   - 进行平衡性检验
   - 敏感性分析

3. **注意事项**
   - 假设不可验证，需谨慎
   - 报告置信区间
   - 进行多种方法对比

---

## 八、常见追问 & 陷阱

### 追问 1: "你说用 PSM，具体怎么做？"

**完整回答**：
1. 估计倾向得分（Logistic 回归 / GBM）
2. 检查共同支撑（overlap）
3. 执行匹配（最近邻 / 卡尺 / 多对一）
4. 检查平衡性（SMD < 0.1）
5. 在匹配样本上估计 ATT
6. 敏感性分析

### 追问 2: "CUPED 有什么局限性？"

**回答**：
1. 需要实验前的协变量（新用户没有）
2. 协变量与结果相关性低时效果有限
3. 不能解决偏差，只能减少方差
4. 可能增加计算复杂度

### 追问 3: "DID 平行趋势不满足怎么办？"

**回答**：
1. **合成控制法**：构建加权对照组
2. **条件平行趋势**：控制时变混淆变量
3. **三重差分 (DDD)**：加入第三个差分维度
4. **敏感性分析**：报告不同假设下的结果

### 陷阱题: "对撞变量应该控制吗？"

**正确答案**：不应该！控制对撞变量会引入虚假关联。

---

## 九、速记口诀

```
因果推断三板斧：识别、估计、敏感性
方法选择看数据：实验最好，自然次之，观测谨慎
DID 记得查趋势，RDD 记得看断点
PSM 要查 Balance，IPW 要查权重
CATE 用 Learners，Uplift 看 Qini
面试记住讲逻辑，不是背公式
```

---

*本速查表配合 Notebook 练习使用，建议面试前通读一遍*
