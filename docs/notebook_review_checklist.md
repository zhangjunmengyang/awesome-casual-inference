# Jupyter Notebook 教程质量审核标准

> 本文档为 Agent 审核教程质量的完备标准。审核时需逐项检查，发现问题需明确指出位置和修复建议。

## 审核原则

```
严格性 > 宽容性    # 宁可误报，不可漏报
可执行 > 看起来对  # 必须实际运行验证
用户视角 > 作者视角  # 站在学习者角度审视
看到即修复       # 发现问题立即修复，不遗留任何问题
```

**重要：看到即修复原则**

本项目的目标是产出**最高质量的面试准备文档**。审核过程中：
- 发现任何问题必须**立即修复**，不允许仅记录而不修复
- 审核报告的目的是记录修复过程，而非留待后续处理
- 每次审核结束时，notebook 应达到 🟢 通过状态

---

## 一、代码正确性审核

### 1.1 可执行性检查

**审核要点：**

- [ ] **顺序执行无报错**：从头到尾 Restart & Run All 能通过
- [ ] **依赖完整**：所有 import 语句在文件开头，无遗漏
- [ ] **变量定义先于使用**：不存在 NameError
- [ ] **数据类型匹配**：函数参数类型、返回值类型正确

**常见问题：**

| 问题类型 | 示例 | 严重程度 |
|---------|------|---------|
| 未定义变量 | 使用了 `df` 但未执行生成 `df` 的 cell | 🔴 致命 |
| Import 遗漏 | 使用 `np.where` 但没 `import numpy as np` | 🔴 致命 |
| 类型错误 | `bins=30` 但数据 range 为 0 无法分 bin | 🔴 致命 |
| 索引越界 | `df.iloc[100]` 但只有 50 行 | 🔴 致命 |

### 1.2 数据生成逻辑检查

**审核要点：**

- [ ] **随机种子设置**：确保可复现性
- [ ] **数据生成与文档描述一致**：Markdown 中的 DGP 公式必须与代码实现完全匹配
- [ ] **潜在结果逻辑正确**：
  - 如果 Y(0) 和 Y(1) 用同一个 noise，ITE 将是常数，无法画分布图
  - 如果 Y(0) 和 Y(1) 用独立 noise，需要在文档中说明
- [ ] **处理效应设计合理**：
  - ATE/CATE 的真实值是否符合预期？
  - 异质性效应是否有业务含义？

**必须检查的公式-代码一致性：**

```markdown
# 文档中写的 DGP：
$$Y(0) = 50 + 5X + \epsilon$$
$$Y(1) = 60 + 5X + \epsilon$$  # 同一个 ε

# 代码中实现的：
noise_0 = np.random.randn(n) * 5
noise_1 = np.random.randn(n) * 5  # 两个不同的 ε
Y0 = 50 + 5 * X + noise_0
Y1 = 60 + 5 * X + noise_1
```

**如果不一致，必须：**
1. 修改文档使其与代码匹配，或
2. 修改代码使其与文档匹配

### 1.3 统计/机器学习逻辑检查

**审核要点：**

- [ ] **模型训练测试分离**：不能用测试集训练
- [ ] **数据泄露检查**：特征工程不能使用未来信息
- [ ] **评估指标合理**：分类用 accuracy/AUC，回归用 MSE/MAE
- [ ] **样本量足够**：演示效果需要足够样本，避免高方差

---

## 二、原理正确性审核

### 2.1 公式正确性检查

**审核要点：**

- [ ] **LaTeX 语法正确**：公式能正常渲染
- [ ] **数学符号一致**：同一个概念在全文使用同一符号
- [ ] **公式推导正确**：中间步骤无跳跃或错误
- [ ] **符号说明完整**：每个符号都有解释

**常见公式错误：**

| 错误类型 | 示例 |
|---------|------|
| 期望符号混用 | $E[Y|T=1]$ vs $\mathbb{E}[Y|T=1]$ 不一致 |
| 条件概率错误 | $P(Y|T)$ 写成 $P(Y,T)$ |
| 求和范围遗漏 | $\sum_i$ 没说明 $i$ 的范围 |
| 下标不一致 | 文中用 $Y_i(1)$，代码用 `Y1` |

### 2.2 概念准确性检查

**审核要点：**

- [ ] **术语使用正确**：ATE、ATT、CATE 等定义准确
- [ ] **因果假设明确**：SUTVA、Ignorability、Overlap 等假设是否说明
- [ ] **方法适用条件**：是否说明方法的前提假设和局限性
- [ ] **与主流文献一致**：定义和符号是否与经典教材/论文一致

**必须检查的核心概念：**

| 概念 | 正确定义 | 常见错误 |
|-----|---------|---------|
| ATE | $E[Y(1) - Y(0)]$ | 误写为 $E[Y|T=1] - E[Y|T=0]$（这是朴素估计） |
| ATT | $E[Y(1) - Y(0) | T=1]$ | 与 ATE 混淆 |
| ITE | $Y_i(1) - Y_i(0)$ | 误认为可以直接观测 |
| 反事实 | 未发生的潜在结果 | 与"预测"混淆 |
| 混淆 | X 同时影响 T 和 Y | 误认为只要 X 与 T 相关就是混淆 |

### 2.3 因果图检查（如涉及 DAG）

**审核要点：**

- [ ] **箭头方向正确**：因 → 果
- [ ] **混淆路径正确**：后门路径识别正确
- [ ] **调整集合理**：条件集选择符合后门准则/前门准则
- [ ] **不存在对撞偏倚**：未错误地控制中介或对撞变量

---

## 三、教学设计审核

### 3.1 TODO 与答案配合检查

**审核要点：**

- [ ] **TODO 有意义**：代码块内有 `# TODO` 或 `# === 你的代码 ===` 等留白
- [ ] **TODO 后不能直接给出答案**：如果 TODO 下面直接写了完整代码，TODO 就失去意义
- [ ] **参考答案位置正确**：
  - 应该在 TODO 代码块**之后**，而不是之前
  - 应该使用 `<details>` 折叠，避免直接可见
  - 应该与 TODO 一一对应
- [ ] **提示充分但不过度**：
  - 有足够提示让学习者知道方向
  - 但不能把答案直接写在提示里

**错误示例：**

```python
# 错误：TODO 下面直接给出了完整代码，失去练习意义
def generate_data(n: int = 100) -> pd.DataFrame:
    # TODO 1: 生成 X
    X = np.random.randn(n)  # ← 这就是答案，TODO 没意义了

    # TODO 2: 生成 Y
    Y = 2 * X + np.random.randn(n)  # ← 同样，已经写好了

    return pd.DataFrame({'X': X, 'Y': Y})
```

**正确做法（二选一）：**

**选项 A：留空让学习者填写**
```python
def generate_data(n: int = 100) -> pd.DataFrame:
    # TODO 1: 生成 X（标准正态分布）
    # 提示：使用 np.random.randn
    X = None  # ← 你的代码

    # TODO 2: 生成 Y = 2X + ε
    # 提示：ε 是标准正态噪声
    Y = None  # ← 你的代码

    return pd.DataFrame({'X': X, 'Y': Y})
```

**选项 B：移除 TODO 标记，作为示范代码**
```python
# 示范代码：数据生成
def generate_data(n: int = 100) -> pd.DataFrame:
    """生成模拟数据（已实现，可直接运行）"""
    X = np.random.randn(n)
    Y = 2 * X + np.random.randn(n)
    return pd.DataFrame({'X': X, 'Y': Y})
```

### 3.4 TODO/答案统一设计模式（必须遵循）

为确保全项目一致性，所有 notebook 必须采用以下**统一设计模式**：

**模式一：练习型代码块**

用于需要学习者动手实现的代码：

```python
# ============================================================
# 🎯 练习：[练习标题]
# ============================================================
# 目标：[简要说明目标]
# 提示：
#   1. [提示1]
#   2. [提示2]
# ============================================================

def your_function():
    # === 你的代码开始 ===

    pass  # 删除此行，填入你的代码

    # === 你的代码结束 ===
```

练习代码块之后**必须**紧跟折叠的参考答案：

```markdown
<details>
<summary>💡 点击查看参考答案</summary>

\`\`\`python
def your_function():
    # 完整实现代码
    return result
\`\`\`

**解析**：[简要解释关键点]

</details>
```

**模式二：示范型代码块**

用于演示概念、无需学习者修改的代码：

```python
# ------------------------------------------------------------
# 📖 示范：[示范标题]
# ------------------------------------------------------------
# 说明：此代码演示 [概念]，可直接运行

def demo_function():
    """
    演示 [功能描述]
    """
    # 完整实现，带详细注释
    return result
```

**关键规则**：
- 练习型代码块：必须有 TODO 标记 + 留空 + 折叠答案
- 示范型代码块：不能有 TODO 标记，代码完整可运行
- **绝对禁止**：TODO 标记后直接给出完整代码（混合模式）

### 3.2 内容顺序检查

**审核要点：**

- [ ] **概念先于应用**：先解释原理，再写代码
- [ ] **简单先于复杂**：从基础示例开始，逐步增加难度
- [ ] **思考题位置合理**：
  - 应该在相关内容**之后**立即出现
  - 不应该把所有思考题堆在最后
  - 思考题和面试题应该分开
- [ ] **总结位置正确**：在所有内容**之后**

**错误的结构示例：**

```
Part 1: 概念
Part 2: 代码
Part 3: 面试题  ← 思考题应该在这之前
Part 4: 数学推导  ← 应该在概念部分
Part 5: 思考题  ← 位置太靠后了
Part 6: 总结
```

**正确的结构：**

```
Part 1: 概念 + 公式 + 数学推导
Part 2: 代码实现
Part 3: 可视化分析
Part 4: 思考题（基础 → 进阶）
Part 5: 面试题模拟
Part 6: 总结
```

### 3.3 参考答案检查

**审核要点：**

- [ ] **使用折叠标签**：`<details><summary>` 格式
- [ ] **答案与问题匹配**：不能答非所问
- [ ] **位置紧跟问题**：不要把答案放到很远的地方
- [ ] **代码答案可执行**：复制粘贴能直接运行

---

## 四、案例真实性审核

### 4.1 场景可信度检查

**审核要点：**

- [ ] **场景有业务逻辑**：不是纯粹的 $X_1, X_2, Y$
- [ ] **数值量级合理**：价格、数量、比例等符合常识
- [ ] **效应方向合理**：正/负效应有业务解释
- [ ] **特征有业务含义**：每个变量代表什么要清楚

**差的案例：**
```python
X = np.random.randn(1000, 5)  # 5个特征，不知道是什么
T = np.random.binomial(1, 0.5, 1000)
Y = T * 10 + X @ [1, 2, 3, 4, 5] + np.random.randn(1000)
```

**好的案例：**
```python
# 电商优惠券场景
user_age = np.random.randint(18, 65, 1000)           # 用户年龄
purchase_history = np.random.poisson(10, 1000)       # 历史购买次数
days_since_last_visit = np.random.exponential(7, 1000)  # 距上次访问天数
received_coupon = np.random.binomial(1, 0.5, 1000)   # 是否收到优惠券
purchase_amount = ...                                  # 购买金额
```

### 4.2 效应设计检查

**审核要点：**

- [ ] **异质性有业务含义**：
  - 哪些人效应大？为什么？
  - 哪些人效应小甚至为负？为什么？
- [ ] **效应大小合理**：
  - 不要太大（不现实）
  - 不要太小（看不出效果）
- [ ] **包含边界情况**：
  - 有正效应的人群
  - 有负效应的人群
  - 效应接近 0 的人群

### 4.3 避免 Toy Example 陷阱

**审核要点：**

- [ ] **不只是跑通代码**：要有分析、解读、洞察
- [ ] **结果要有业务结论**：
  - 不只是 "ATE = 10.23"
  - 而是 "补习班平均提高 10 分，对基础差的学生效果更好"
- [ ] **包含决策建议**：基于结果应该怎么做？

---

## 五、可视化质量审核

### 5.1 图表完整性检查

**审核要点：**

- [ ] **有标题**：说明图表展示的内容
- [ ] **有坐标轴标签**：x 轴、y 轴都要有
- [ ] **有图例**：多系列数据必须有图例
- [ ] **有单位**：数值要有单位说明

### 5.2 图表正确性检查

**审核要点：**

- [ ] **数据范围合理**：不截断关键信息
- [ ] **颜色区分清晰**：不同系列颜色有区分
- [ ] **图表类型合适**：
  - 分布用直方图/密度图
  - 趋势用折线图
  - 比较用柱状图
  - 关系用散点图

### 5.3 直方图特殊检查

**审核要点：**

- [ ] **bins 数量合理**：
  - 如果数据几乎无变异，`bins=30` 会报错
  - 推荐使用 `bins='auto'` 或根据数据动态计算
- [ ] **数据有变异**：如果所有值相同，直方图无意义

---

## 六、文档一致性审核

### 6.1 前后一致性检查

**审核要点：**

- [ ] **变量名一致**：代码中的变量名与文档描述一致
- [ ] **数值一致**：文档说 ATE=10，代码生成的也应该约等于 10
- [ ] **公式符号一致**：$\epsilon$ 不要一会儿 $\epsilon$ 一会儿 $\varepsilon$
- [ ] **术语一致**：同一概念不要换名字

### 6.2 Markdown 格式检查

**审核要点：**

- [ ] **标题层级正确**：# → ## → ### 递进
- [ ] **代码块格式正确**：```python 标记
- [ ] **公式渲染正确**：$ 和 $$ 使用正确
- [ ] **表格格式正确**：列对齐

---

## 七、审核报告模板

审核完成后，按以下格式输出报告：

```markdown
# Notebook 审核报告

## 基本信息
- **文件**：`part0_1_potential_outcomes.ipynb`
- **审核时间**：2024-01-04
- **审核结果**：🔴 有严重问题 / 🟡 有轻微问题 / 🟢 通过

## 发现的问题

### 🔴 严重问题（必须修复）

#### 问题 1：[问题标题]
- **位置**：cell-9, 第 15 行
- **问题描述**：...
- **影响**：...
- **修复建议**：...

### 🟡 轻微问题（建议修复）

#### 问题 2：[问题标题]
- **位置**：cell-4
- **问题描述**：...
- **修复建议**：...

### 🟢 改进建议（可选）

1. ...
2. ...

## 修复清单

| # | 问题 | 位置 | 严重程度 | 状态 |
|---|------|------|---------|------|
| 1 | DGP 公式与代码不一致 | cell-4 | 🔴 | ⏳ 待修复 |
| 2 | TODO 后直接给出答案 | cell-5 | 🟡 | ⏳ 待修复 |
```

---

## 八、快速检查清单

供快速审核使用：

### 代码层面
- [ ] Restart & Run All 无报错
- [ ] 所有 import 在开头
- [ ] 数据生成与 DGP 公式一致
- [ ] 直方图 bins 参数合理

### 教学层面
- [ ] TODO 后不直接给答案
- [ ] 参考答案使用折叠标签
- [ ] 参考答案位置在问题之后
- [ ] 思考题在内容之后、面试题之前

### 内容层面
- [ ] 公式符号有解释
- [ ] 场景有业务含义
- [ ] 结果有业务解读
- [ ] 效应设计合理

### 一致性
- [ ] 文档公式与代码实现一致
- [ ] 变量名前后一致
- [ ] 数值结果与预期一致

---

> 审核时务必实际运行 notebook，不要只看代码。很多问题只有运行时才能发现。
